# Generated by Django 4.0.7 on 2022-10-23 10:53

import django.core.serializers.json
from django.db import migrations, models
import django.db.models.deletion


def migrate_report_to_project(apps, schema_editor):
    PentestReport = apps.get_model('pentests', 'PentestReport')
    PentestProject = apps.get_model('pentests', 'PentestProject')
    ReportSection = apps.get_model('pentests', 'ReportSection')
    PentestFinding = apps.get_model('pentests', 'PentestFinding')

    # Delete unreferenced reports (remainders of deleted projects)
    PentestReport.objects \
        .filter(project__isnull=True) \
        .delete()

    projects = list(PentestProject.objects.select_related('report').all())
    for p in projects:
        p.custom_fields = {'title': p.report.title} | p.report.custom_fields
    PentestProject.objects.bulk_update(projects, ['custom_fields'])

    sections = list(ReportSection.objects.select_related('report__project').all())
    for s in sections:
        s.project = s.report.project
    ReportSection.objects.bulk_update(sections, ['project'])

    findings = list(PentestFinding.objects.select_related('report__project').all())
    for f in findings:
        f.project = f.report.project
    PentestFinding.objects.bulk_update(findings, ['project'])


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0018_remove_findingtemplate_imported_and_more'),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name='pentestfinding',
            unique_together=set(),
        ),
        migrations.AlterUniqueTogether(
            name='reportsection',
            unique_together=set(),
        ),
         migrations.AddField(
            model_name='pentestfinding',
            name='project',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, related_name='findings', to='pentests.pentestproject'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='pentestproject',
            name='custom_fields',
            field=models.JSONField(default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder),
        ),
        migrations.AddField(
            model_name='reportsection',
            name='project',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, related_name='sections', to='pentests.pentestproject'),
            preserve_default=False,
        ),

        migrations.RunPython(code=migrate_report_to_project),
    ]
