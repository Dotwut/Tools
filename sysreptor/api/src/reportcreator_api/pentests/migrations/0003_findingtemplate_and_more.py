# Generated by Django 4.0.4 on 2022-07-20 17:08

import django.core.serializers.json
from django.db import migrations, models
import reportcreator_api.pentests.customfields.mixins
import reportcreator_api.pentests.customfields.predefined_fields
import reportcreator_api.pentests.customfields.types
import reportcreator_api.pentests.customfields.utils
import reportcreator_api.pentests.customfields.validators
import reportcreator_api.utils.models
import uuid


def migrate_field_definition_static_to_origin(apps, schema_editor):
    ProjectType = apps.get_model('pentests', 'projecttype')
    for pt in ProjectType.objects.all():
        # Load and serialize definition to update format to current structure
        pt.finding_fields = reportcreator_api.pentests.customfields.types.field_definition_to_dict(
            reportcreator_api.pentests.customfields.utils.set_field_origin(
                reportcreator_api.pentests.customfields.types.parse_field_definition(pt.finding_fields), 
                reportcreator_api.pentests.customfields.predefined_fields.FINDING_FIELDS_CORE | reportcreator_api.pentests.customfields.predefined_fields.FINDING_FIELDS_PREDEFINED))
        pt.report_fields = reportcreator_api.pentests.customfields.types.field_definition_to_dict(
            reportcreator_api.pentests.customfields.utils.set_field_origin(
                reportcreator_api.pentests.customfields.types.parse_field_definition(pt.report_fields),
                reportcreator_api.pentests.customfields.predefined_fields.REPORT_FIELDS_CORE | reportcreator_api.pentests.customfields.predefined_fields.REPORT_FIELDS_PREDEFINED))
        pt.save()


class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0002_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='FindingTemplate',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created', models.DateTimeField(auto_now_add=True)),
                ('updated', models.DateTimeField(auto_now=True)),
                ('usage_count', models.PositiveIntegerField(db_index=True, default=0)),
                ('tags', django.contrib.postgres.fields.ArrayField(base_field=models.CharField(max_length=255), db_index=True, default=list, size=None)),
                ('title', models.TextField(db_index=True, default='')),
                ('cvss', models.CharField(default='n/a', max_length=50)),
                ('custom_fields', models.JSONField(default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder)),
            ],
            options={
                'ordering': ['-usage_count', '-created'],
            },
            bases=(reportcreator_api.pentests.customfields.mixins.CustomFieldsMixin, models.Model, reportcreator_api.utils.models.ModelDiffMixin),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='finding_fields',
            field=models.JSONField(default=reportcreator_api.pentests.customfields.predefined_fields.finding_fields_default, encoder=django.core.serializers.json.DjangoJSONEncoder, validators=[reportcreator_api.pentests.customfields.validators.FieldDefinitionValidator(core_fields=reportcreator_api.pentests.customfields.predefined_fields.FINDING_FIELDS_CORE, predefined_fields=reportcreator_api.pentests.customfields.predefined_fields.FINDING_FIELDS_PREDEFINED)]),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='report_fields',
            field=models.JSONField(default=reportcreator_api.pentests.customfields.predefined_fields.report_fields_default, encoder=django.core.serializers.json.DjangoJSONEncoder, validators=[reportcreator_api.pentests.customfields.validators.FieldDefinitionValidator(core_fields=reportcreator_api.pentests.customfields.predefined_fields.REPORT_FIELDS_CORE, predefined_fields=reportcreator_api.pentests.customfields.predefined_fields.REPORT_FIELDS_PREDEFINED)]),
        ),
        migrations.RunPython(code=migrate_field_definition_static_to_origin),
        migrations.AlterField(
            model_name='pentestfinding',
            name='risk_level',
            field=models.CharField(choices=[('none', 'None'), ('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], db_index=True, default='none', max_length=10),
        ),
        migrations.AlterField(
            model_name='pentestfinding',
            name='risk_score',
            field=models.FloatField(db_index=True, default=0.0),
        ),
        migrations.AlterField(
            model_name='pentestfinding',
            name='title',
            field=models.TextField(db_index=True, default=''),
        ),
        migrations.AlterField(
            model_name='pentestproject',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='pentestreport',
            name='title',
            field=models.TextField(db_index=True, default=''),
        ),
        migrations.AlterField(
            model_name='projecttype',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
        migrations.AlterField(
            model_name='uploadedasset',
            name='name',
            field=models.CharField(db_index=True, max_length=255),
        ),
    ]
