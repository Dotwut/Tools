# Generated by Django 4.0.7 on 2022-08-31 07:44

from django.db import migrations, models
import django.db.models.deletion
from reportcreator_api.pentests.models import ReportSection
import reportcreator_api.utils.models
import uuid


def migrate_create_sections(apps, schema_editor):
    ReportSection = apps.get_model('pentests', 'ReportSection')
    PentestProject = apps.get_model('pentests', 'PentestProject')

    sections = []
    for p in PentestProject.objects.select_related('report', 'project_type').all():
        sections.extend([ReportSection(report=p.report, section_id=s.get('id')) for s in p.project_type.report_sections])
    ReportSection.objects.bulk_create(sections)



class Migration(migrations.Migration):

    dependencies = [
        ('pentests', '0010_alter_pentestproject_options_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='ReportSection',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('created', models.DateTimeField(auto_now_add=True)),
                ('updated', models.DateTimeField(auto_now=True)),
                ('section_id', models.CharField(db_index=True, max_length=255)),
                ('report', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='pentests.pentestreport')),
            ],
            options={
                'ordering': ['-created'],
                'abstract': False,
                'unique_together': {('report', 'section_id')},
            },
            bases=(reportcreator_api.utils.models.ModelDiffMixin, models.Model),
        ),
        migrations.RunPython(code=migrate_create_sections, reverse_code=migrations.RunPython.noop),
    ]
