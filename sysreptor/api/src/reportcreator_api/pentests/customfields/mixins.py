from django.db import models
from django.core.serializers.json import DjangoJSONEncoder
from reportcreator_api.archive.crypto.fields import EncryptedField
from reportcreator_api.pentests.customfields.types import FieldDefinition

from reportcreator_api.pentests.customfields.utils import HandleUndefinedFieldsOptions, ensure_defined_structure
from reportcreator_api.pentests.customfields.validators import FieldValuesValidator
from reportcreator_api.utils.utils import copy_keys, omit_keys, merge


class CustomFieldsMixin(models.Model):
    custom_fields = models.JSONField(encoder=DjangoJSONEncoder, default=dict)

    class Meta:
        abstract = True

    @property
    def field_definition(self) -> dict[str, FieldDefinition]:
        return {}

    @property
    def core_field_names(self) -> list[str]:
        return []

    @property
    def data(self) -> dict:
        """
        Return a dict of all field values.
        Sets default values, if a field is not defined.
        Does not include data of undefined fields not present in the definition.
        """
        return self.get_data()

    @property
    def data_all(self) -> dict:
        return self.get_data(include_undefined=True)

    def get_data(self, handle_undefined=HandleUndefinedFieldsOptions.FILL_NONE, include_undefined=False) -> dict:
        # Build dict of all current values
        # Merge core fields stored directly on the model instance and custom_fields stored as dict
        out = self.custom_fields.copy()
        for k in self.core_field_names:
            out[k] = getattr(self, k)
        
        # recursively check for undefined fields and set default value
        out = ensure_defined_structure(value=out, definition=self.field_definition, handle_undefined=handle_undefined, include_undefined=include_undefined)

        return out


    def update_data(self, value):
        # Merge with previous custom data
        value = merge(self.data, value)

        # Validate data
        FieldValuesValidator(self.field_definition)(value)

        # Distribute to model fields
        for k, v in copy_keys(value, self.core_field_names).items():
            setattr(self, k, v)
        self.custom_fields = self.custom_fields | omit_keys(value, self.core_field_names)


class EncryptedCustomFieldsMixin(CustomFieldsMixin):
    custom_fields = EncryptedField(base_field=models.JSONField(encoder=DjangoJSONEncoder, default=dict))

    class Meta(CustomFieldsMixin.Meta):
        abstract = True

