import hashlib
from django.db import models
from reportcreator_api.archive.crypto.fields import EncryptedField
from reportcreator_api.pentests import querysets, storages
from reportcreator_api.users.models import PentestUser

from reportcreator_api.utils.models import BaseModel


class UploadedFileBase(BaseModel):
    file = models.FileField()
    name = EncryptedField(base_field=models.CharField(max_length=255))
    name_hash = models.BinaryField(max_length=32, db_index=True)
    uploaded_by = models.ForeignKey(to=PentestUser, on_delete=models.SET_NULL, null=True)

    class Meta(BaseModel.Meta):
        abstract = True
        unique_together = [['linked_object', 'name_hash']]

    @classmethod
    def hash_name(cls, name) -> bytes:
        return hashlib.sha3_256(name.encode()).digest()

    def save(self, *args, **kwargs):
        self.name_hash = self.hash_name(self.name)
        return super().save(*args, **kwargs)


class UploadedImage(UploadedFileBase):
    file = models.ImageField(storage=storages.get_uploaded_image_storage)
    linked_object = models.ForeignKey(to='PentestProject', on_delete=models.CASCADE, related_name='images')

    objects = querysets.UploadedImageManager()  


class UploadedAsset(UploadedFileBase):
    file = models.FileField(storage=storages.get_uploaded_asset_storage)
    linked_object = models.ForeignKey(to='ProjectType', on_delete=models.CASCADE, related_name='assets')

    objects = querysets.UploadedAssetManager() 


class UploadedUserNotebookImage(UploadedFileBase):  
    file = models.ImageField(storage=storages.get_uploaded_image_storage)
    linked_object = models.ForeignKey(to=PentestUser, on_delete=models.CASCADE, related_name='images')

    objects = querysets.UploadedUserNotebookImageManager()


class UploadedProjectFile(UploadedFileBase):
    file = models.FileField(storage=storages.get_uploaded_file_storage)
    linked_object = models.ForeignKey(to='PentestProject', on_delete=models.CASCADE, related_name='files')

    objects = querysets.UploadedProjectFileManager()

